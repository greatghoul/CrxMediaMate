<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘æ’­æ”¾é€»è¾‘æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .timing-info {
      background-color: #e8f4f8;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #2196F3;
    }
    .code-block {
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      overflow-x: auto;
    }
    .timing-calculation {
      background-color: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border-color: #28a745;
    }
    .timeline {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .timeline-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    .timeline-time {
      width: 80px;
      font-weight: bold;
      color: #007bff;
    }
    .timeline-action {
      flex: 1;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ è§†é¢‘æ’­æ”¾é€»è¾‘æµ‹è¯•éªŒè¯</h1>
    
    <div class="timing-info">
      <h3>ğŸ“Š æ–°çš„æ’­æ”¾é€»è¾‘</h3>
      <p><strong>è¦æ±‚:</strong> å¿…é¡»æ˜¯åœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡ä¹‹åï¼Œæ‰å¼€å§‹æ’­æ”¾å¯¹åº”çš„æè¿°è¯­éŸ³</p>
      <p><strong>å®ç°:</strong> å›¾ç‰‡æ˜¾ç¤º0.5ç§’åå¼€å§‹æ’­æ”¾æè¿°è¯­éŸ³ï¼Œæ’­æ”¾å®Œæˆåæš‚åœ0.5ç§’åˆ‡æ¢ä¸‹ä¸€å¼ å›¾ç‰‡</p>
    </div>

    <div class="timing-calculation success">
      <h3>â±ï¸ å®Œæ•´æ—¶é—´çº¿</h3>
      <div class="timeline">
        <h4>ç¬¬ä¸€å¼ å›¾ç‰‡:</h4>
        <div class="timeline-item">
          <span class="timeline-time">0.0s</span>
          <span class="timeline-action">â¤ å›¾ç‰‡1æ˜¾ç¤º</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">0.5s</span>
          <span class="timeline-action">ğŸ”Š å¼€å§‹æ’­æ”¾å›¾ç‰‡1çš„æè¿°è¯­éŸ³</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">X.Xs</span>
          <span class="timeline-action">ğŸ”‡ å›¾ç‰‡1è¯­éŸ³æ’­æ”¾å®Œæˆ</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">+0.5s</span>
          <span class="timeline-action">â¸ï¸ æš‚åœ0.5ç§’</span>
        </div>
        
        <h4>ç¬¬äºŒå¼ å›¾ç‰‡:</h4>
        <div class="timeline-item">
          <span class="timeline-time">Y.Ys</span>
          <span class="timeline-action">â¤ å›¾ç‰‡2æ˜¾ç¤º</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">+0.5s</span>
          <span class="timeline-action">ğŸ”Š å¼€å§‹æ’­æ”¾å›¾ç‰‡2çš„æè¿°è¯­éŸ³</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">Z.Zs</span>
          <span class="timeline-action">ğŸ”‡ å›¾ç‰‡2è¯­éŸ³æ’­æ”¾å®Œæˆ</span>
        </div>
        <div class="timeline-item">
          <span class="timeline-time">+0.5s</span>
          <span class="timeline-action">â¸ï¸ æš‚åœ0.5ç§’</span>
        </div>
      </div>
    </div>

    <div class="timing-calculation">
      <h3>ğŸ”§ æŠ€æœ¯å®ç°</h3>
      <div class="code-block">
// éŸ³é¢‘æ··åˆé€»è¾‘
for (let i = 0; i < speechDataArray.length; i++) {
  // å…ˆé™éŸ³0.5ç§’ï¼ˆå›¾ç‰‡æ˜¾ç¤ºæœŸé—´ï¼‰
  currentOffset += imageShowDelayMs; // 500ms
  
  // ç„¶åæ’­æ”¾éŸ³é¢‘
  const startSample = Math.floor(currentOffset * sampleRate / 1000);
  addAudioToBuffer(mixedBuffer, speechData.audioBuffer, startSample);
  
  // éŸ³é¢‘æ’­æ”¾æ—¶é—´
  currentOffset += speechData.duration;
  
  // æœ€åæš‚åœ0.5ç§’ï¼ˆé™¤äº†æœ€åä¸€å¼ å›¾ç‰‡ï¼‰
  if (i < speechDataArray.length - 1) {
    currentOffset += pauseMs; // 500ms
  }
}

// å›¾ç‰‡æ¸²æŸ“é€»è¾‘
const renderImageWithTransition = async (img, speech, canvas, ctx, imageIndex, totalImages) => {
  // ç›´æ¥æ˜¾ç¤ºå›¾ç‰‡ï¼ˆæ— æ¸å˜æ•ˆæœï¼‰
  ctx.drawImage(imageCanvas, x, y);
  
  // å›¾ç‰‡æ˜¾ç¤º0.5ç§’åï¼ŒéŸ³é¢‘å¼€å§‹æ’­æ”¾
  await new Promise(resolve => setTimeout(resolve, imageShowDelay)); // 500ms
  
  // ç­‰å¾…éŸ³é¢‘æ’­æ”¾å®Œæˆ
  await new Promise(resolve => setTimeout(resolve, speech.duration));
  
  // éŸ³é¢‘æ’­æ”¾å®Œæˆåæš‚åœ0.5ç§’å†åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
  if (imageIndex < totalImages - 1) {
    await new Promise(resolve => setTimeout(resolve, pauseDuration)); // 500ms
  }
};
      </div>
    </div>

    <div class="timing-calculation success">
      <h3>âœ… å…³é”®æ”¹è¿›</h3>
      <ul>
        <li><strong>å›¾ç‰‡ä¼˜å…ˆæ˜¾ç¤º:</strong> å›¾ç‰‡ç«‹å³æ˜¾ç¤ºï¼Œ0.5ç§’åæ‰å¼€å§‹æ’­æ”¾è¯­éŸ³</li>
        <li><strong>éŸ³é¢‘ä¸¥æ ¼åŒæ­¥:</strong> éŸ³é¢‘è½¨é“ä¸­ä¸ºæ¯å¼ å›¾ç‰‡é¢„ç•™0.5ç§’é™éŸ³æ—¶é—´</li>
        <li><strong>æ— æ¸å˜åˆ‡æ¢:</strong> å›¾ç‰‡ä¹‹é—´ç›´æ¥åˆ‡æ¢ï¼Œæ— è¿‡æ¸¡æ•ˆæœ</li>
        <li><strong>æ—¶é—´ç²¾ç¡®æ§åˆ¶:</strong> æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶</li>
      </ul>
    </div>

    <div class="timing-info">
      <h3>ğŸ“ˆ æ—¶é—´è®¡ç®—å…¬å¼</h3>
      <div class="code-block">
æ¯å¼ å›¾ç‰‡æ€»æ—¶é•¿ = å›¾ç‰‡æ˜¾ç¤ºå»¶è¿Ÿ(0.5s) + éŸ³é¢‘æ’­æ”¾æ—¶é•¿ + æš‚åœæ—¶é—´(0.5s)

ä¾‹å¦‚ï¼š
- å›¾ç‰‡1: 0.5s + 3.2s + 0.5s = 4.2s
- å›¾ç‰‡2: 0.5s + 2.8s + 0.5s = 3.8s  
- å›¾ç‰‡3: 0.5s + 4.1s + 0s = 4.6s (æœ€åä¸€å¼ æ— æš‚åœ)

æ€»æ—¶é•¿ = 4.2s + 3.8s + 4.6s = 12.6s
      </div>
    </div>

    <script>
      // ç®€å•çš„æ—¶é—´è®¡ç®—æ¼”ç¤º
      function calculateDetailedTiming() {
        const images = [
          {duration: 3200, description: "ç¬¬ä¸€å¼ æç¬‘å›¾ç‰‡"},
          {duration: 2800, description: "ç¬¬äºŒå¼ æç¬‘å›¾ç‰‡"},
          {duration: 4100, description: "ç¬¬ä¸‰å¼ æç¬‘å›¾ç‰‡"}
        ];
        
        let currentTime = 0;
        let totalDuration = 0;
        
        console.log("=== è¯¦ç»†è§†é¢‘æ—¶é—´è½´ ===");
        
        images.forEach((img, index) => {
          console.log(`${(currentTime/1000).toFixed(1)}s: ${img.description} å¼€å§‹æ˜¾ç¤º`);
          
          // å›¾ç‰‡æ˜¾ç¤º0.5ç§’
          currentTime += 500;
          totalDuration += 500;
          console.log(`${(currentTime/1000).toFixed(1)}s: ${img.description} éŸ³é¢‘å¼€å§‹æ’­æ”¾`);
          
          // éŸ³é¢‘æ’­æ”¾æ—¶é—´
          currentTime += img.duration;
          totalDuration += img.duration;
          console.log(`${(currentTime/1000).toFixed(1)}s: ${img.description} éŸ³é¢‘æ’­æ”¾å®Œæˆ`);
          
          // æš‚åœæ—¶é—´ï¼ˆé™¤äº†æœ€åä¸€å¼ ï¼‰
          if (index < images.length - 1) {
            currentTime += 500;
            totalDuration += 500;
            console.log(`${(currentTime/1000).toFixed(1)}s: æš‚åœç»“æŸï¼Œå‡†å¤‡åˆ‡æ¢ä¸‹ä¸€å¼ `);
          }
        });
        
        console.log(`æ€»æ—¶é•¿: ${totalDuration}ms (${(totalDuration/1000).toFixed(1)}ç§’)`);
        
        // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const timingDiv = document.createElement('div');
        timingDiv.className = 'timing-calculation success';
        timingDiv.innerHTML = `
          <h3>ğŸ¯ è®¡ç®—ç»“æœ</h3>
          <p><strong>æ€»è§†é¢‘æ—¶é•¿:</strong> ${(totalDuration/1000).toFixed(1)}ç§’</p>
          <p><strong>å›¾ç‰‡æ•°é‡:</strong> ${images.length}å¼ </p>
          <p><strong>å›¾ç‰‡æ˜¾ç¤ºå»¶è¿Ÿ:</strong> ${images.length} Ã— 0.5ç§’ = ${images.length * 0.5}ç§’</p>
          <p><strong>æš‚åœæ—¶é—´:</strong> ${images.length - 1} Ã— 0.5ç§’ = ${(images.length - 1) * 0.5}ç§’</p>
          <p><strong>æ€»éŸ³é¢‘æ—¶é•¿:</strong> ${(images.reduce((sum, img) => sum + img.duration, 0)/1000).toFixed(1)}ç§’</p>
        `;
        document.body.appendChild(timingDiv);
      }
      
      // é¡µé¢åŠ è½½åæ‰§è¡Œè®¡ç®—
      window.addEventListener('load', calculateDetailedTiming);
    </script>
  </div>
</body>
</html>
